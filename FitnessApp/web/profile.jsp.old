<%-- 
    Document   : profile
    Created on : 22-Mar-2018, 18:30:07
    Author     : 100021268
--%>

<%@page import="java.text.SimpleDateFormat"%>
<%@page import="model.HealthScore"%>
<%@page import="model.Calculations"%>
<%@page import="model.HealthData"%>
<%@page import="controller.PersistanceController"%>
<%@page import="model.User"%>
<%@page import="java.util.Date"%>
<%@page import="java.util.Calendar"%>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Welcome</title>
        <!--<link rel="stylesheet" type="text/css" href="css/bootstrap.css">-->
    </head>
    <body>
        <div class="container">
            <br>
            <%
            //Redirect to login page if user session is invalid
            HttpSession httpSession = request.getSession();
            String email = (String) httpSession.getAttribute("email");
            String password = (String) httpSession.getAttribute("password");
            if(email == null){
                response.sendRedirect("userLogin.jsp");
            }
            
            User user = PersistanceController.getUser(email, password);
            
            String messageType = (String)request.getAttribute("messageType");
            String message = (String)request.getAttribute("message"); 
            String name = (String)request.getAttribute("firstName"); 
            if(message!=null){
                String messageCSS = "alert";
                switch(messageType){
                case "Success":
                    messageCSS = "alert alert-success";
                    break;
                case "Error":
                    messageCSS = "alert alert-danger";
                    break;
                }
                %>
                <div class="<%= messageCSS%>">
                    <strong><%= messageType%>!</strong> <%= message%>
                </div>
            <%}
                HealthScore healthScore = new HealthScore(user);
                String healthScoreMsg = Integer.toString(healthScore.getHealthScore());
                SimpleDateFormat formatter = new SimpleDateFormat("dd/MM/yyyy");
                String oldDate = null;
                try{
                    oldDate = formatter.format(PersistanceController.getMostRecentHealthScore(email).getDateTime());
                }catch (Exception ex){
                    oldDate = "";
                }
                String newDate = formatter.format(healthScore.getDateTime());
                if(!oldDate.equals(newDate))
                    PersistanceController.addHealthScore(healthScore, email);

                name = (String) httpSession.getAttribute("name");
                
                Date date = new Date();
                Calendar cal = Calendar.getInstance();
                cal.setTime(date);
                String timeOfDay = "morning";
                int hour = cal.get(Calendar.HOUR_OF_DAY);

                if (hour >= 12 && hour < 17) {
                    timeOfDay = "afternoon";
                }
                else if (hour >= 17) {
                    timeOfDay = "evening";
                }
            %>
                <p> Good <%= timeOfDay%>, <%= name%>!</p>
                
                <p> Health Score :  <%= healthScoreMsg%></p>
            <p><a href="profile.jsp" class="btn btn-info" role="button">Home</a></p>
            <p><a href="exerciseLog.jsp" class="btn btn-info" role="button">Exercise Log</a></p>
            <p><a href="foodLog.jsp" class="btn btn-info" role="button">Food Log</a></p>
            <p><a href="updateWeight.jsp" class="btn btn-info" role="button">Weight Log</a></p>
            <p><a href="goals.jsp" class="btn btn-info" role="button">Goals</a></p>
            <p><a href="settings.jsp" class="btn btn-info" role="button">Settings</a></p>

           <h2>Calories remaining today</h2>
           <p>2048</p>

           <h2>You'll reach your goal in</h2>
           <p>67 days</p>
           
            <%
            HealthData recentData = PersistanceController.getMostRecentHealthData(email);
            String weight = Double.toString(recentData.getWeight());
            String BMI = Double.toString(Calculations.BMI(recentData.getWeight(), recentData.getHeight()));
            String BMIClass = Calculations.BMIClass(recentData.getWeight(), recentData.getHeight());

            double BMR = Calculations.BMR(user);
            String totalCals = Double.toString(Calculations.BMR(user));

            double caloriesBurnt = ((hour/24.0f)*BMR);
            %>
            <h2>Update Weight</h2>
            <p>Weight: <%= weight%>kg</p>
            <p>BMI: <%= BMI%> | <%= BMIClass%></p>
            <h2>Calories burnt today</h2>
            <p><%= caloriesBurnt%> / <%= totalCals%></p>
            
            
            
            <form class="form-inline" action="WebController">
                <input type="hidden" name="formType" value="logout">
                <button type="submit" class="btn btn-primary">Logout</button>
            </form>
        </div>
    </body>
</html>
